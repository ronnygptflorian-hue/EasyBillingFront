<app-loading
  [show]="loading"
  [fullscreen]="true"
  message="Cargando clientes"
></app-loading>

<div class="page-wrapper" *ngIf="!loading">
  <header class="page-header">
    <div>
      <h1>Clientes</h1>
      <p>Gestiona tu cartera de clientes</p>
    </div>
    <button (click)="openModal()" class="btn btn-primary btn-new">
      <span class="btn-icon">‚ûï</span>
      <span>Nuevo Cliente</span>
    </button>
  </header>

  <div class="toolbar">
    <div class="search-box-container">
      <div class="search-icon">üîç</div>
      <input
        type="text"
        class="search-input"
        placeholder="Buscar por nombre o raz√≥n social..."
        [(ngModel)]="searchQuery"
        (input)="onSearchChange()"
      />
    </div>

    <div class="filter-group">
      <select
        [(ngModel)]="filterTipoId"
        (ngModelChange)="onFilterChange()"
        class="filter-select"
      >
        <option value="all">Todos los tipos</option>
        <option value="C">C√©dula (11 d√≠gitos)</option>
        <option value="R">RNC (9 d√≠gitos)</option>
        <option value="P">Pasaporte</option>
      </select>

      <button
        *ngIf="searchQuery || filterTipoId !== 'all'"
        (click)="clearFilters()"
        class="btn-clear-filters"
        title="Limpiar filtros"
      >
        ‚úï
      </button>
    </div>

    <div class="page-size-selector">
      <label>Mostrar:</label>
      <select
        [(ngModel)]="pageSize"
        (ngModelChange)="changePageSize()"
        class="page-size-select"
      >
        <option *ngFor="let size of pageSizeOptions" [value]="size">
          {{ size }}
        </option>
      </select>
      <span>por p√°gina</span>
    </div>
    <div class="results-count">
      {{ totalRecords }} cliente{{ totalRecords !== 1 ? "s" : "" }}
    </div>
  </div>

  <div class="table-container">
    <div class="empty-state" *ngIf="clientes.length === 0">
      <div class="empty-icon">üë•</div>
      <h3>No se encontraron clientes</h3>
      <p>
        {{
          searchQuery
            ? "Intenta con otro t√©rmino de b√∫squeda"
            : "Comienza agregando tu primer cliente"
        }}
      </p>
      <button
        (click)="openModal()"
        class="btn btn-primary"
        *ngIf="!searchQuery"
      >
        <span>‚ûï</span>
        Crear Primer Cliente
      </button>
    </div>

    <table class="clients-table" *ngIf="clientes.length > 0">
      <thead>
        <tr>
          <th>Cliente</th>
          <th>RNC/C√©dula</th>
          <th>Contacto</th>
          <th>Ubicaci√≥n</th>
          <th>Estado</th>
          <th class="text-center">Acciones</th>
        </tr>
      </thead>
      <tbody>
        <tr
          *ngFor="let cliente of clientes"
          [class.blocked]="cliente.bloqueado"
        >
          <td>
            <div class="client-info-cell">
              <div class="client-avatar-small">
                {{
                  (cliente.razonSocial || cliente.nombreComercial)
                    .substring(0, 2)
                    .toUpperCase()
                }}
              </div>
              <div class="client-details">
                <div class="client-name-table">
                  {{ cliente.razonSocial || cliente.nombreComercial }}
                </div>
                <div
                  class="client-commercial-table"
                  *ngIf="
                    cliente.nombreComercial &&
                    cliente.nombreComercial !== cliente.razonSocial
                  "
                >
                  {{ cliente.nombreComercial }}
                </div>
              </div>
            </div>
          </td>
          <td>
            <span class="rnc-badge">{{ cliente.rnc }}</span>
          </td>
          <td>
            <div class="contact-cell">
              <div class="contact-item" *ngIf="cliente.telefonos">
                <span class="contact-icon">üìû</span>
                <span>{{ cliente.telefonos }}</span>
              </div>
              <div class="contact-item" *ngIf="cliente.eMail">
                <span class="contact-icon">üìß</span>
                <span>{{ cliente.eMail }}</span>
              </div>
              <span class="no-data" *ngIf="!cliente.telefonos && !cliente.eMail"
                >Sin contacto</span
              >
            </div>
          </td>
          <td>
            <div
              class="location-cell"
              *ngIf="cliente.ciudad || cliente.provincia"
            >
              <span class="location-icon">üìç</span>
              <span
                >{{ cliente.ciudad
                }}{{ cliente.ciudad && cliente.provincia ? ", " : ""
                }}{{ cliente.provincia }}</span
              >
            </div>
            <span class="no-data" *ngIf="!cliente.ciudad && !cliente.provincia"
              >Sin ubicaci√≥n</span
            >
          </td>
          <td>
            <span
              class="status-badge"
              [class.status-blocked]="cliente.bloqueado"
              [class.status-active]="!cliente.bloqueado"
            >
              {{ cliente.bloqueado ? "Bloqueado" : "Activo" }}
            </span>
          </td>
          <td class="actions-cell">
            <button
              (click)="openModal(cliente)"
              class="btn-table-action edit"
              title="Editar"
            >
              ‚úèÔ∏è
            </button>
            <button class="btn-table-action delete" title="Eliminar">üóëÔ∏è</button>
          </td>
        </tr>
      </tbody>
    </table>
    <div class="pagination-container" *ngIf="clientes.length > 0">
      <div class="pagination-info">
        Mostrando {{ (currentPage - 1) * pageSize + 1 }} -
        {{ Math.min(currentPage * pageSize, clientes.length) }} de
        {{ clientes.length }}
      </div>

      <div class="pagination-controls">
        <button
          class="pagination-btn"
          [disabled]="currentPage === 1"
          (click)="goToPage(1)"
          title="Primera p√°gina"
        >
          ‚èÆ
        </button>

        <button
          class="pagination-btn"
          [disabled]="currentPage === 1"
          (click)="goToPage(currentPage - 1)"
          title="P√°gina anterior"
        >
          ‚óÄ
        </button>

        <button
          *ngFor="let page of getPageNumbers()"
          class="pagination-btn"
          [class.active]="page === currentPage"
          (click)="goToPage(page)"
        >
          {{ page }}
        </button>

        <button
          class="pagination-btn"
          [disabled]="currentPage === totalPages"
          (click)="goToPage(currentPage + 1)"
          title="P√°gina siguiente"
        >
          ‚ñ∂
        </button>

        <button
          class="pagination-btn"
          [disabled]="currentPage === totalPages"
          (click)="goToPage(totalPages)"
          title="√öltima p√°gina"
        >
          ‚è≠
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Hermoso -->
<!-- <div class="modal-overlay" *ngIf="showModal" (click)="closeModal()">
  <div class="modal-beautiful" (click)="$event.stopPropagation()">
    <div class="modal-header-beautiful">
      <div class="modal-title-section">
        <div class="modal-icon">üë§</div>
        <div>
          <h2>{{ isEditing ? "Editar Cliente" : "Nuevo Cliente" }}</h2>
          <p>
            {{
              isEditing
                ? "Actualiza la informaci√≥n del cliente"
                : "Agrega un nuevo cliente a tu cartera"
            }}
          </p>
        </div>
      </div>
      <button (click)="closeModal()" class="btn-close-beautiful">‚úï</button>
    </div>

    <form (ngSubmit)="addClient()" class="modal-body-beautiful">
      <div class="form-section">
        <h3 class="section-title">Informaci√≥n B√°sica</h3>
        <div class="form-grid-2">
          <div class="form-group-beautiful">
            <label>Tipo de Identificaci√≥n</label>
            <select
              class="input-beautiful"
              [(ngModel)]="currentCliente.tipoId"
              name="tipoId"
            >
              <option *ngFor="let tipo of tipoIdOptions" [value]="tipo.value">
                {{ tipo.label }}
              </option>
            </select>
          </div>

          <div class="form-group-beautiful">
            <label>RNC/C√©dula <span class="required">*</span></label>
            <input
              type="text"
              class="input-beautiful"
              [(ngModel)]="currentCliente.rnc"
              name="rnc"
              placeholder="Documento"
              required
              (input)="validarLongitudDocumento()"
              maxlength="{{
                currentCliente.tipoId === 'C'
                  ? 11
                  : currentCliente.tipoId === 'R'
                  ? 9
                  : 50
              }}"
            />
          </div>
        </div>
      </div>

      <div class="form-section">
        <h3 class="section-title">Informaci√≥n Comercial</h3>
        <div class="form-group-beautiful">
          <label>Raz√≥n Social</label>
          <input
            type="text"
            class="input-beautiful"
            [(ngModel)]="currentCliente.razonSocial"
            name="razonSocial"
            placeholder="Nombre legal de la empresa"
          />
        </div>

        <div class="form-group-beautiful">
          <label>Nombre Comercial</label>
          <input
            type="text"
            class="input-beautiful"
            [(ngModel)]="currentCliente.nombreComercial"
            name="nombreComercial"
            placeholder="Nombre comercial o marca"
          />
        </div>
      </div>

      <div class="form-section">
        <h3 class="section-title">Ubicaci√≥n</h3>
        <div class="form-group-beautiful">
          <label>Direcci√≥n</label>
          <textarea
            class="input-beautiful"
            [(ngModel)]="currentCliente.direccion"
            name="direccion"
            rows="2"
            placeholder="Calle, n√∫mero, sector"
          ></textarea>
        </div>

        <div class="form-grid-3">
          <div class="form-group-beautiful">
            <label>Ciudad</label>
            <input
              type="text"
              class="input-beautiful"
              [(ngModel)]="currentCliente.ciudad"
              name="ciudad"
              placeholder="Ciudad"
            />
          </div>

          <div class="form-group-beautiful">
            <label>Provincia</label>
            <select
              class="input-beautiful"
              [(ngModel)]="currentCliente.provincia"
              name="provincia"
            >
              <option *ngFor="let prov of provincias" [value]="prov">
                {{ prov }}
              </option>
            </select>
          </div>

          <div class="form-group-beautiful">
            <label>C√≥digo Postal</label>
            <input
              type="text"
              class="input-beautiful"
              [(ngModel)]="currentCliente.codigoPostal"
              name="codigoPostal"
              placeholder="10147"
            />
          </div>
        </div>
      </div>

      <div class="form-section">
        <h3 class="section-title">Contacto</h3>
        <div class="form-grid-2">
          <div class="form-group-beautiful">
            <label>Tel√©fono</label>
            <div class="input-with-icon">
              <span class="input-icon">üìû</span>
              <input
                type="tel"
                class="input-beautiful"
                [(ngModel)]="currentCliente.telefonos"
                name="telefono"
                placeholder="809-555-5555"
              />
            </div>
          </div>

          <div class="form-group-beautiful">
            <label>Email</label>
            <div class="input-with-icon">
              <span class="input-icon">üìß</span>
              <input
                type="email"
                class="input-beautiful"
                [(ngModel)]="currentCliente.eMail"
                name="email"
                placeholder="cliente@email.com"
              />
            </div>
          </div>
        </div>
      </div>

      <div class="form-section">
        <label class="checkbox-beautiful">
          <input
            type="checkbox"
            [(ngModel)]="currentCliente.bloqueado"
            name="bloqueado"
          />
          <span class="checkbox-label"
            >Cliente bloqueado (no permitir transacciones)</span
          >
        </label>
      </div>

      <div class="modal-footer-beautiful">
        <button
          type="button"
          (click)="closeModal()"
          class="btn btn-secondary btn-large"
        >
          Cancelar
        </button>
        <button type="submit" class="btn btn-primary btn-large">
          <span>üíæ</span>
          {{ isEditing ? "Actualizar" : "Guardar" }} Cliente
        </button>
      </div>
    </form>
  </div>
</div> -->

<modal-crear-cliente
  [showModal]="showModal"
  [isEditing]="isEditing"
  [currentCliente]="currentCliente"
  [tipoIdOptions]="tipoIdOptions"
  [provincias]="provincias"
  (close)="closeModal()"
  (save)="onSaveCliente($event)"
></modal-crear-cliente>
