<app-loading
  [show]="loading"
  [fullscreen]="true"
  message="Cargando Factura..."
></app-loading>
<div class="page-container">
  <div class="page-header">
    <h1>Facturas</h1>

    <div class="header-actions">
      <button class="btn-excel" (click)="exportarExcel()">
        üìó Exportar Excel
      </button>

      <a routerLink="/facturas/crear" class="btn-primary">+ Nueva Factura</a>
    </div>
  </div>

  <div class="filters-container">
    <div class="filters-header">
      <h3>Filtros de B√∫squeda</h3>
      <button (click)="toggleAdvancedFilters()" class="btn-advanced-filters">
        {{ showAdvancedFilters ? "‚ñ≤" : "‚ñº" }} Avanzados
      </button>
    </div>

    <div class="filters-content">
      <div class="filters-grid-main">
        <div class="filter-group">
          <label class="filter-label">NCF</label>
          <input
            type="text"
            [(ngModel)]="filtroNcf"
            placeholder="Buscar por NCF..."
            class="filter-input"
          />
        </div>

        <div class="filter-group">
          <label class="filter-label">Cliente</label>
          <div class="autocomplete-wrapper">
            <input
              type="text"
              [(ngModel)]="searchTerm"
              (input)="onClienteSearch($event)"
              (focus)="onClienteFocus()"
              (blur)="onClienteBlur()"
              placeholder="Buscar cliente..."
              class="filter-input"
              autocomplete="off"
            />
            <div
              class="autocomplete-dropdown"
              *ngIf="showClienteDropdown && clienteSuggestions.length > 0"
            >
              <div
                *ngFor="let cliente of clienteSuggestions"
                class="autocomplete-item"
                (mousedown)="selectCliente(cliente)"
              >
                <div class="cliente-name">{{ cliente.razonSocial }}</div>
                <div class="cliente-rnc">{{ cliente.rnc }}</div>
              </div>
            </div>
          </div>
        </div>

        <div class="filter-group">
          <label class="filter-label">Estado</label>
          <select [(ngModel)]="selectedEstado" class="filter-select">
            <option value="">Todos</option>
            <option value="CO">Contado</option>
            <option value="CR">Cr√©dito</option>
          </select>
        </div>
      </div>

      <div
        class="filters-advanced-section"
        [class.collapsed]="!showAdvancedFilters"
      >
        <div class="filters-grid">
          <div class="filter-group">
            <label class="filter-label">Fecha Desde</label>
            <app-custom-datepicker
              [(ngModel)]="filtroFechaDesde"
              placeholder="Seleccionar fecha"
            ></app-custom-datepicker>
          </div>

          <div class="filter-group">
            <label class="filter-label">Fecha Hasta</label>
            <app-custom-datepicker
              [(ngModel)]="filtroFechaHasta"
              placeholder="Seleccionar fecha"
            ></app-custom-datepicker>
          </div>
        </div>
      </div>

      <div class="filters-actions">
        <button (click)="aplicarFiltros()" class="btn-apply-filters">
          üîç Consultar
        </button>
        <button (click)="limpiarFiltros()" class="btn-clear-filters">
          ‚úñ Limpiar
        </button>
      </div>
    </div>

    <div class="content-card" *ngIf="!loading">
      <div class="table-container">
        <table class="data-table">
          <thead>
            <tr>
              <th>NCF</th>
              <th>Cliente</th>
              <th>Fecha</th>
              <th>ITBIS</th>
              <th>Total</th>
              <th>Estado</th>
              <!-- <th>Tipo</th> -->

              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let factura of filteredFacturas">
              <td class="font-mono">{{ factura.ecf || "N/A" }}</td>
              <td>{{ factura.nombreCliente || "N/A" }}</td>
              <td>{{ formatDate(factura.fechaAdd) }}</td>
              <td>{{ formatCurrency(factura.totalItbis) }}</td>
              <td class="font-bold">
                {{ formatCurrency(factura.totalGeneral) }}
              </td>
              <td>
                <span [class]="'badge ' + getEstadoClass(factura.tipoVenta)">
                  {{ getEstadoLabel(factura.estadoFactura) }}
                </span>
              </td>
              <!-- <td>{{ factura.descripcionTipoEcf || "N/A" }}</td> -->
              <td class="actions">
                <button
                  (click)="viewFactura(factura)"
                  class="btn-icon btn-view"
                  title="Ver detalles"
                >
                  üëÅÔ∏è
                </button>
                <button
                  (click)="printFactura(factura)"
                  class="btn-icon btn-print"
                  title="Imprimir Factura"
                >
                  üñ®Ô∏è
                </button>
                <button
                  *ngIf="
                    factura.descripcionTipoEcf !==
                      'Nota de Cr√©dito Electr√≥nica' &&
                    factura.estadoFactura !== 'Nota Generada'
                  "
                  (click)="crearNotaCredito(factura)"
                  class="btn-icon btn-credit"
                  title="Crear Nota de Cr√©dito"
                >
                  üìù
                </button>

                <button
                  *ngIf="factura.estadoFactura === 'Borrador'"
                  (click)="EditarFactura(factura)"
                  class="btn-icon btn-edit"
                  title="Editar Factura"
                >
                  ‚úèÔ∏è
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <div
      class="empty-state"
      *ngIf="!loading && filteredFacturas.length === 0 && facturas.length === 0"
    >
      <div class="empty-icon">üìÑ</div>
      <h3>No hay facturas</h3>
      <p>Crea tu primera factura para comenzar</p>
      <a routerLink="/facturas/crear" class="btn-primary">Crear Factura</a>
    </div>

    <div
      class="empty-state"
      *ngIf="!loading && filteredFacturas.length === 0 && facturas.length > 0"
    >
      <div class="empty-icon">üîç</div>
      <h3>No se encontraron resultados</h3>
      <p>Intenta con otros criterios de b√∫squeda</p>
    </div>

    <div class="pagination-container" *ngIf="!loading && facturas.length > 0">
      <div class="pagination-info">
        Mostrando {{ (pagination.pageNumber - 1) * pagination.pageSize + 1 }} -
        {{
          Math.min(
            pagination.pageNumber * pagination.pageSize,
            pagination.totalCount
          )
        }}
        de {{ pagination.totalCount }} facturas
      </div>
      <div class="pagination-controls">
        <button
          (click)="previousPage()"
          [disabled]="!pagination.hasPreviousPage"
          class="btn-pagination"
        >
          ‚Üê Anterior
        </button>

        <button
          *ngFor="let page of pages"
          (click)="goToPage(page)"
          [class.active]="page === pagination.pageNumber"
          class="btn-page"
        >
          {{ page }}
        </button>

        <button
          (click)="nextPage()"
          [disabled]="!pagination.hasNextPage"
          class="btn-pagination"
        >
          Siguiente ‚Üí
        </button>
      </div>
    </div>

    <div class="modal" *ngIf="showDetailModal" (click)="closeDetailModal()">
      <div class="modal-content modal-large" (click)="$event.stopPropagation()">
        <div class="modal-header action-header">
          <div class="title-group">
            <h2>Detalle de Factura</h2>

            <div class="action-buttons">
              <button
                class="btn btn-outline"
                (click)="onDownloadPdf(selectedFactura)"
              >
                üìÑ PDF
              </button>
              <button
                class="btn btn-outline"
                (click)="onDownloadXml(selectedFactura)"
              >
                üßæ XML DGII
              </button>
              <button
                *ngIf="
                  selectedFactura?.estadoFactura === 'Borrador' ||
                  selectedFactura?.estadoFactura === 'ErrorFirmando'
                "
                class="btn btn-outline"
                (click)="SignEcf(selectedFactura)"
              >
                üöÄ Enviar a Dgii
              </button>
            </div>
          </div>

          <button (click)="closeDetailModal()" class="btn-close">√ó</button>
        </div>

        <div class="modal-body" *ngIf="selectedFactura">
          <div class="detail-section">
            <h3>Informaci√≥n General</h3>
            <div class="detail-grid">
              <div class="detail-item">
                <label>NCF:</label>
                <span>{{ selectedFactura.ecf || "N/A" }}</span>
              </div>
              <div class="detail-item">
                <label>Tipo ECF:</label>
                <span>{{ selectedFactura.descripcionTipoEcf || "N/A" }}</span>
              </div>
              <!-- <div class="detail-item">
                <label>Cliente:</label>
                <span>{{ selectedFactura.nombreCliente || "N/A" }}</span>
              </div>
              <div class="detail-item">
                <label>RNC/C√©dula:</label>
                <span>{{ selectedFactura.rnc || "N/A" }}</span>
              </div> -->
              <div class="detail-item">
                <label>Fecha Emisi√≥n:</label>
                <span>{{ formatDate(selectedFactura.fechaAdd) }}</span>
              </div>
              <!-- <div class="detail-item">
                <label>Fecha Vencimiento:</label>
                <span>{{ formatDate(selectedFactura.fechaVencimiento) }}</span>
              </div> -->
              <div class="detail-item">
                <label>Tipo Venta:</label>
                <span
                  [class]="'badge ' + getEstadoClass(selectedFactura.tipoVenta)"
                >
                  {{ getEstadoLabel(selectedFactura.tipoVenta) }}
                </span>
              </div>
              <div class="detail-item">
                <label>Moneda:</label>
                <span
                  >{{ selectedFactura.descripcionMoneda }} ({{
                    selectedFactura.codigoISO
                  }})</span
                >
              </div>
            </div>
          </div>

          <div class="detail-section">
            <h3>Informaci√≥n del Cliente</h3>
            <div class="detail-grid">
              <div class="detail-item">
                <label>Cliente:</label>
                <span>{{ selectedFactura.nombreCliente || "N/A" }}</span>
              </div>
              <div class="detail-item">
                <label>RNC/C√©dula:</label>
                <span>{{ selectedFactura.rnc || "N/A" }}</span>
              </div>
              <div class="detail-item">
                <label>Direcci√≥n:</label>
                <span>{{ selectedFactura.direccion || "N/A" }}</span>
              </div>
              <div class="detail-item">
                <label>Tel√©fonos:</label>
                <span>{{ selectedFactura.telefonos || "N/A" }}</span>
              </div>
            </div>
          </div>
          <div
            class="detail-section"
            *ngIf="
              selectedFactura?.informacionReferencia?.ecfModificado !== null
            "
          >
            <h3>Comentario y Referencia</h3>

            <div
              class="detail-item"
              *ngIf="
                selectedFactura.informacionReferencia?.ecfModificado !== null
              "
            >
              <label>Ecf Modificado:</label>
              <span>{{
                selectedFactura?.informacionReferencia?.ecfModificado || "N/A"
              }}</span>
            </div>

            <div
              class="detail-item"
              *ngIf="
                selectedFactura.informacionReferencia?.motivoAnulacion !== null
              "
            >
              <label>Motivo de anulacion:</label>
              <span>{{
                selectedFactura?.informacionReferencia?.motivoAnulacion || "N/A"
              }}</span>
            </div>

            <div
              class="detail-item"
              *ngIf="
                selectedFactura.informacionReferencia?.fechaReferencia !== null
              "
            >
              <label>Fecha Referencia Ecf:</label>
              <span>{{
                selectedFactura?.informacionReferencia?.fechaReferencia || "N/A"
              }}</span>
            </div>

            <div
              class="detail-item"
              *ngIf="
                selectedFactura.informacionReferencia?.razonModificacion !==
                null
              "
            >
              <label>Comentario de la anulacion</label>
              <span>{{
                selectedFactura?.informacionReferencia?.razonModificacion ||
                  "N/A"
              }}</span>
            </div>
          </div>

          <div
            class="detail-section"
            *ngIf="
              selectedFactura.detalles && selectedFactura.detalles.length > 0
            "
          >
            <h3>Productos / Servicios</h3>
            <div class="products-table-wrapper">
              <table class="products-detail-table">
                <thead>
                  <tr>
                    <th>Producto</th>
                    <th>Cant.</th>
                    <th>Precio</th>
                    <th>Desc.</th>
                    <th>ITBIS</th>
                    <th>Total</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let detalle of selectedFactura.detalles">
                    <td>
                      <div class="product-info">
                        <div class="product-name">
                          {{ detalle.descripcionProducto }}
                        </div>

                        <div class="product-meta">
                          {{ detalle.descripcionMedida }} -
                          {{ detalle.descripcionItbi }}

                          <span *ngIf="detalle.porcientoDescuento > 0">
                            ‚Ä¢ Descuento: {{ detalle.porcientoDescuento }}%
                          </span>

                          <span *ngIf="detalle.porcientoRecargo > 0">
                            ‚Ä¢ Recargo: {{ detalle.porcientoRecargo }}%
                          </span>

                          <span *ngIf="detalle.tipoRetencion">
                            ‚Ä¢ Retenci√≥n: ITBIS
                            {{
                              detalle.valorItbisRetencion | number : "1.2-2"
                            }}, ISR
                            {{ detalle.valorIsrRetencion | number : "1.2-2" }}
                          </span>

                          <span
                            *ngIf="
                              detalle.impuestosAdicionales &&
                              detalle.impuestosAdicionales.length > 0
                            "
                          >
                            ‚Ä¢ Impuestos Adicionales:
                          </span>

                          <div
                            class="extra-taxes"
                            *ngIf="
                              detalle.impuestosAdicionales &&
                              detalle.impuestosAdicionales.length > 0
                            "
                          >
                            <div
                              *ngFor="let adic of detalle.impuestosAdicionales"
                            >
                              ‚Üí {{ adic.porcientoImpuesto }}% ({{
                                formatCurrency(adic.valorImpuesto)
                              }})
                            </div>
                          </div>
                        </div>
                      </div>
                    </td>

                    <td class="text-center">{{ detalle.cantidad }}</td>

                    <td class="text-right">
                      {{ formatCurrency(detalle.precio) }}
                    </td>

                    <td class="text-right">
                      <span *ngIf="detalle.valorDescuento > 0">{{
                        formatCurrency(detalle.valorDescuento)
                      }}</span>
                      <span *ngIf="detalle.valorDescuento == 0">‚Äî</span>
                    </td>

                    <td class="text-right">
                      {{ formatCurrency(detalle.valorItbis) }}
                    </td>

                    <td class="text-right font-bold">
                      {{ formatCurrency(detalle.totalDetalle) }}
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <div class="detail-section">
            <h3>Totales</h3>

            <div class="totals-grid">
              <div class="total-item">
                <label>Subtotal:</label>
                <span>{{ formatCurrency(getSubtotal(selectedFactura)) }}</span>
              </div>

              <div class="total-item">
                <label>Descuento:</label>
                <span>{{
                  formatCurrency(selectedFactura.totalDescuento)
                }}</span>
              </div>

              <div class="total-item">
                <label>ITBIS:</label>
                <span>{{ formatCurrency(selectedFactura.totalItbis) }}</span>
              </div>

              <div class="total-item">
                <label>Otros Impuestos:</label>
                <span>{{ formatCurrency(selectedFactura.totalImpuesto) }}</span>
              </div>

              <div class="total-item">
                <label>Total Retenci√≥n:</label>
                <span>{{
                  formatCurrency(getTotalRetencion(selectedFactura))
                }}</span>
              </div>

              <div class="total-item total-final">
                <label>Total General:</label>
                <span>{{ formatCurrency(selectedFactura.totalGeneral) }}</span>
              </div>
            </div>
          </div>

          <div class="detail-section" *ngIf="selectedFactura.qrDgii">
            <h3>Informaci√≥n DGII</h3>
            <div class="dgii-info-container">
              <div class="qr-code-container">
                <div class="qr-code-wrapper">
                  <img
                    [src]="getQrCodeUrl(selectedFactura.qrDgii)"
                    alt="C√≥digo QR DGII"
                    class="qr-code-image"
                    (error)="onQrImageError($event)"
                  />
                  <p class="qr-instruction">Escanea para verificar</p>
                  <div class="qr-details">
                    <div class="qr-detail-item">
                      <span class="qr-detail-label"
                        >C√≥digo de Seguridad:
                        <span class="qr-detail-value">{{
                          selectedFactura.codigoSeguridad || "N/A"
                        }}</span></span
                      >
                    </div>
                    <div class="qr-detail-item">
                      <span class="qr-detail-label"
                        >Fecha Firma:
                        <span class="qr-detail-value">{{
                          selectedFactura.fechaFirmaDgii || "N/A"
                        }}</span></span
                      >
                    </div>
                  </div>
                </div>
                <a
                  [href]="selectedFactura.qrDgii"
                  target="_blank"
                  class="qr-link-button"
                >
                  üîó Ver Comprobante en DGII
                </a>
              </div>
            </div>
          </div>
        </div>

        <p>{{ selectedFactura?.comentario }}</p>

        <div class="modal-actions">
          <button (click)="closeDetailModal()" class="btn-secondary">
            Cerrar
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
